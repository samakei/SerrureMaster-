events {}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout  65;
	etag on;
	gzip on;
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_min_length 1024;
	gzip_types text/plain text/css application/javascript application/json image/svg+xml;

	server {
		# Cloud Run expects port 8080
		listen 8080;
		server_name _;

		root /usr/share/nginx/html;
		index index.html;

		# Cache JS/CSS bundles aggressively (hashés par Vite)
		location ~* ^/assets/.*\.(js|css|mjs)$ {
			expires 1y;
			add_header Cache-Control "public, max-age=31536000, immutable";
			try_files $uri =404;
		}

		# Cache images et fonts en long TTL
		location ~* \.(png|jpg|jpeg|gif|svg|ico|webp|woff|woff2)$ {
			expires 30d;
			add_header Cache-Control "public, max-age=2592000";
			try_files $uri =404;
		}

		# Toujours revalider HTML pour éviter de bloquer les nouveaux déploiements
		location = /index.html {
			expires -1;
			add_header Cache-Control "no-cache";
			try_files $uri =404;
		}

		# SPA fallback to index.html
		location / {
			try_files $uri $uri/ /index.html;
		}

		# Healthcheck endpoint for Cloud Run
		location = /_health {
			return 200 'ok';
			add_header Content-Type text/plain;
		}
	}
}

